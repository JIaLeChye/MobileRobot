name: Auto Update Library Versions

on:
  push:
    branches: [ master, main ]
    paths:
      - 'Libraries/**'

jobs:
  update-library-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true
        ref: ${{ github.head_ref || github.ref }}
    
    - name: Setup Git
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "Library Version Bot"
        git config --global pull.rebase false
        echo "üîß Git configuration complete"
    
    - name: Check for library changes and update versions
      run: |
        echo "üîç Checking for library file changes..."
        
        # Check if this commit was made by the version bot (avoid infinite loops)
        COMMIT_MESSAGE=$(git log -1 --pretty=%B)
        if [[ "$COMMIT_MESSAGE" == *"Auto-update library versions"* ]]; then
          echo "üõë This commit was made by version bot, skipping to avoid infinite loop"
          exit 0
        fi
        
        # Define library directories
        LIB_DIRS=(
          "Libraries/RPi_Robot_Hat_Lib/"
          "Libraries/Ultrasonic_Sensor/"
          "Libraries/IR_Sensor/"
        )
        
        # Function to validate SemVer format
        validate_semver() {
          local version="$1"
          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid SemVer format: $version"
            return 1
          fi
          return 0
        }
        
        # Function to increment PATCH version (SemVer compliant)
        increment_patch() {
          local version="$1"
          local major=$(echo "$version" | cut -d. -f1)
          local minor=$(echo "$version" | cut -d. -f2)
          local patch=$(echo "$version" | cut -d. -f3)
          patch=$((patch + 1))
          echo "${major}.${minor}.${patch}"
        }
        
        # Function to update version in Python file
        update_python_version() {
          local file="$1"
          local new_version="$2"
          if grep -q 'self\.lib_ver=' "$file"; then
            sed -i "s/self\.lib_ver= \"[^\"]*\"/self.lib_ver= \"${new_version}\"/" "$file"
            echo "‚úÖ Updated Python version to $new_version in $file"
            return 0
          fi
          return 1
        }
        
        # Function to update version in setup.py
        update_setup_version() {
          local file="$1"
          local new_version="$2"
          if grep -q 'version=' "$file"; then
            sed -i "s/version=\"[^\"]*\"/version=\"${new_version}\"/" "$file"
            echo "‚úÖ Updated setup.py version to $new_version in $file"
            return 0
          fi
          return 1
        }
        
        # Function to update version in __init__.py
        update_init_version() {
          local file="$1"
          local new_version="$2"
          if grep -q '__version__' "$file"; then
            sed -i "s/__version__ = \"[^\"]*\"/__version__ = \"${new_version}\"/" "$file"
            echo "‚úÖ Updated __init__.py version to $new_version in $file"
            return 0
          fi
          return 1
        }
        
        # Robust push function with conflict resolution
        robust_push() {
          local max_attempts=5
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "üöÄ Push attempt $attempt/$max_attempts..."
            
            # Fetch latest changes
            git fetch origin ${{ github.ref_name }}
            
            # Check if we're behind
            LOCAL=$(git rev-parse HEAD)
            REMOTE=$(git rev-parse origin/${{ github.ref_name }})
            
            if [ "$LOCAL" != "$REMOTE" ]; then
              echo "‚ö†Ô∏è  Remote has new commits, rebasing..."
              
              # Stash our changes if any
              git stash push -m "Auto-version update stash" || true
              
              # Pull with rebase
              git pull --rebase origin ${{ github.ref_name }}
              
              # Apply our stashed changes
              git stash pop || true
              
              # Re-add files in case of conflicts
              git add Libraries/*/setup.py Libraries/*/*.py Libraries/*/__init__.py 2>/dev/null || true
              
              # Commit again if needed
              if ! git diff --cached --quiet; then
                git commit -m "üîñ Auto-update library versions (PATCH) [skip ci]" || true
              fi
            fi
            
            # Try to push
            if git push origin HEAD:${{ github.ref_name }}; then
              echo "‚úÖ Successfully pushed on attempt $attempt"
              return 0
            else
              echo "‚ùå Push failed on attempt $attempt"
              if [ $attempt -eq $max_attempts ]; then
                echo "üí• Failed to push after $max_attempts attempts"
                return 1
              fi
              
              # Wait before retry with exponential backoff
              sleep_time=$((2 ** attempt))
              echo "‚è≥ Waiting ${sleep_time}s before retry..."
              sleep $sleep_time
            fi
            
            attempt=$((attempt + 1))
          done
        }
        
        # Get changed files in this push
        changed_files=$(git diff --name-only HEAD~1 HEAD)
        echo "üìù Changed files:"
        echo "$changed_files"
        echo ""
        
        # Check if any library files were changed
        lib_files_changed=false
        for lib_dir in "${LIB_DIRS[@]}"; do
          if echo "$changed_files" | grep -q "^${lib_dir}"; then
            lib_files_changed=true
            echo "üìö Library files changed in: $lib_dir"
          fi
        done
        
        if [ "$lib_files_changed" = false ]; then
          echo "‚ÑπÔ∏è  No library files changed, versions remain unchanged"
          exit 0
        fi
        
        echo ""
        echo "üîÑ SemVer compliant auto-versioning activated..."
        echo "üîß Auto-incrementing PATCH versions (bug fixes)"
        echo ""
        
        files_updated=false
        
        # Update RPi_Robot_Hat_Lib if changed
        if echo "$changed_files" | grep -q "^Libraries/RPi_Robot_Hat_Lib/"; then
          ROBOT_HAT_FILE="Libraries/RPi_Robot_Hat_Lib/RPi_Robot_Hat_Lib.py"
          ROBOT_HAT_SETUP="Libraries/RPi_Robot_Hat_Lib/setup.py"
          ROBOT_HAT_INIT="Libraries/RPi_Robot_Hat_Lib/__init__.py"
          
          if [ -f "$ROBOT_HAT_FILE" ]; then
            # Extract current version
            current_version=$(grep -o 'self\.lib_ver= "[^"]*"' "$ROBOT_HAT_FILE" | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
            
            if [ -z "$current_version" ] || ! validate_semver "$current_version"; then
              current_version="1.0.0"
              echo "‚ö†Ô∏è  No valid SemVer found in RPi_Robot_Hat_Lib, starting with $current_version"
            fi
            
            new_version=$(increment_patch "$current_version")
            echo "üìà RPi_Robot_Hat_Lib: $current_version ‚Üí $new_version (PATCH)"
            
            # Update all version locations
            if update_python_version "$ROBOT_HAT_FILE" "$new_version"; then
              files_updated=true
            fi
            
            if [ -f "$ROBOT_HAT_SETUP" ]; then
              update_setup_version "$ROBOT_HAT_SETUP" "$new_version"
            fi
            
            if [ -f "$ROBOT_HAT_INIT" ]; then
              update_init_version "$ROBOT_HAT_INIT" "$new_version"
            fi
            
            echo "‚úÖ RPi_Robot_Hat_Lib updated to SemVer $new_version"
            echo ""
          fi
        fi
        
        # Update other libraries if changed
        for lib_dir in "Libraries/Ultrasonic_Sensor" "Libraries/IR_Sensor"; do
          if echo "$changed_files" | grep -q "^${lib_dir}/"; then
            setup_file="$lib_dir/setup.py"
            init_file="$lib_dir/__init__.py"
            
            if [ -f "$setup_file" ]; then
              # Extract current version
              current_version=$(grep -o 'version="[^"]*"' "$setup_file" | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+' | head -1)
              
              if [ -z "$current_version" ] || ! validate_semver "$current_version"; then
                current_version="1.0.0"
                echo "‚ö†Ô∏è  No valid SemVer found in $(basename "$lib_dir"), starting with $current_version"
              fi
              
              new_version=$(increment_patch "$current_version")
              lib_name=$(basename "$lib_dir")
              echo "üìà $lib_name: $current_version ‚Üí $new_version (PATCH)"
              
              # Update versions
              if update_setup_version "$setup_file" "$new_version"; then
                files_updated=true
              fi
              
              if [ -f "$init_file" ]; then
                update_init_version "$init_file" "$new_version"
              fi
              
              echo "‚úÖ $lib_name updated to SemVer $new_version"
              echo ""
            fi
          fi
        done
        
        # Commit version updates if any files were updated
        if [ "$files_updated" = true ]; then
          echo "üì¶ Committing version updates..."
          git add Libraries/*/setup.py Libraries/*/*.py Libraries/*/__init__.py
          git commit -m "üîñ Auto-update library versions (PATCH) [skip ci]" || true
          
          # Use robust push with conflict resolution
          if robust_push; then
            echo "üéâ Library versions updated and committed successfully!"
          else
            echo "üí• Failed to push version updates after multiple attempts"
            echo "‚ÑπÔ∏è  This might be due to concurrent pushes, but versions were updated locally"
            exit 1
          fi
        else
          echo "‚ÑπÔ∏è  No version files needed updating"
        fi
        
        echo ""
        echo "üìñ SemVer Reference: https://semver.org/"
        echo "üí° For MINOR/MAJOR versions, use manual semver_bump.sh script"
